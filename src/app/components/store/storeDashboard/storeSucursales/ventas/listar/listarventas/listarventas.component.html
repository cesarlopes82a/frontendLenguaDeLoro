

<hr>

<div class="card ">
    <div class="card-header">
        V E N T A S: <strong>{{sucursalNombre}}</strong>
    </div>

    <button type="submit" class="btn btn-primary" [routerLink]="['/sucursal/' + this.branchId + '/ventas/vender']" [routerLinkActive]="['actived']" >Registrar Nueva Venta</button>

    <div class="card-body">
        <div class="mat-elevation-z8">
            <hr>
            <div class="row">
                <div class="col-md-4">
                    <mat-form-field appearance="fill">
                        <mat-label>Rango de fechas</mat-label>
                        <mat-date-range-input [rangePicker]="picker" >
                            <!--
                                <input matStartDate formControlName="start" placeholder="Start date"  name="rangeStart" [(ngModel)]="startDate" >
                        <input matEndDate formControlName="end" placeholder="End date" name="rangeEnd" [(ngModel)]="endDate">
                            -->
                        <input matStartDate placeholder="Start date"  name="rangeStart" [(ngModel)]="startDate" >
                        <input matEndDate placeholder="End date" name="rangeEnd" [(ngModel)]="endDate">
                        </mat-date-range-input>
                        <mat-hint>MM/DD/YYYY â€“ MM/DD/YYYY</mat-hint>
                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-date-range-picker #picker ></mat-date-range-picker>
                    </mat-form-field>

                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary" (click)="aplicarFiltro()">Filtrar</button>
                </div>
                <div class="col-md-2">
                    <button mat-raised-button class="text-secondary bg-warning" (click)="openDialogGraphVenta()">graficar<mat-icon> bar_chart</mat-icon></button>
                    
                </div>
                <div class="col-md-2">
                    <mat-form-field appearance="fill">
                        <mat-label>Vendedor</mat-label>
                        <mat-select [(value)]="selectedUser" >
                          <mat-option [value]="'Todos'" *ngIf="loggedUserRole!='vendedor'">Todos</mat-option>
                          <mat-option [value]="option._id" *ngFor="let option of usrsFoundEnVentas">{{ option.username}}</mat-option>
                          
                        </mat-select>
                    </mat-form-field>
                      
                </div>
                
                

                
            </div>
            <hr>

            
        </div>  
        <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="mat-elevation-z8">
                
            <ng-container *ngFor="let column of columnsToDisplay">
                <ng-container matColumnDef="{{column}}">
                    <th  mat-header-cell *matHeaderCellDef> {{column}} </th>
                    <ng-container *ngIf="column == 'fecha'">                    
                            <td mat-cell *matCellDef="let transaction">
                                <ng-container *ngIf='transaction.anulada == false' >
                                    {{transaction.fecha  | date:'medium'}}
                                </ng-container>
                                <ng-container *ngIf='transaction.anulada == true'>                                    
                                    <p style="color: #FF3333"> {{transaction.fecha | date:'medium'}} (anulada) </p>
                                </ng-container>                                  
                            </td>                        
                        <td mat-footer-cell *matFooterCellDef>  </td>                         
                    </ng-container>
                    <ng-container *ngIf="column == 'sucursal'">
                            <td mat-cell *matCellDef="let transaction">
                                <ng-container *ngIf='transaction.anulada == false' >
                                    {{transaction.sucursal.branchName}}
                                </ng-container>
                                <ng-container *ngIf='transaction.anulada == true'>                                    
                                    <p style="color: #FF3333">{{transaction.sucursal.branchName}}</p>
                                </ng-container>                                  
                            </td> 
                        <td mat-footer-cell *matFooterCellDef>  </td>
                    </ng-container>
                    <ng-container *ngIf="column == 'vendedor'">
                            <td mat-cell *matCellDef="let transaction">
                                <ng-container *ngIf='transaction.anulada == false' >
                                    {{transaction.vendedor.username}}
                                </ng-container>
                                <ng-container *ngIf='transaction.anulada == true'>                                                                        
                                    <p style="color: #FF3333">{{transaction.vendedor.username}}</p>
                                </ng-container>                                  
                            </td> 
                        <td mat-footer-cell *matFooterCellDef> TOTAL: </td>
                    </ng-container>
                    <ng-container *ngIf="column == 'tarjeta'">                        
                        <td mat-cell *matCellDef="let transaction">
                            <ng-container *ngIf='transaction.anulada == false' >
                                {{transaction.tarjeta | currency }}
                            </ng-container>
                            <ng-container *ngIf='transaction.anulada == true'>                                    
                                <p style="color: #FF3333">{{transaction.tarjeta | currency }}</p>
                            </ng-container>                                  
                        </td> 
                        <td mat-footer-cell *matFooterCellDef> {{ this.totalVtasTarjeta | currency }} </td>
                        <td mat-footer-cell *matFooterCellDef>  </td>
                    </ng-container>
                    <ng-container *ngIf="column == 'efectivo'">
                            <td mat-cell *matCellDef="let transaction">
                                <ng-container *ngIf='transaction.anulada == false' >
                                    {{transaction.efectivo | currency}} 
                                </ng-container>
                                <ng-container *ngIf='transaction.anulada == true'>                                    
                                    <p style="color: #FF3333">{{transaction.efectivo | currency}} </p>
                                </ng-container>                                  
                            </td> 
                        <td mat-footer-cell *matFooterCellDef> {{ this.totalVtasEfectivo | currency }} </td>
                        <td mat-footer-cell *matFooterCellDef>  </td>
                    </ng-container>
                    <ng-container *ngIf="column == 'saldo'">
                        <td mat-cell *matCellDef="let transaction">
                            <ng-container *ngIf='transaction.anulada == false' >
                                {{transaction.saldo | currency}} 
                            </ng-container>
                            <ng-container *ngIf='transaction.anulada == true'>                                    
                                <p style="color: #FF3333">{{transaction.saldo | currency}}</p>
                            </ng-container>                                  
                        </td> 
                        <td mat-footer-cell *matFooterCellDef> {{ this.totalVtasPendienteCobro | currency }}  </td>
                        <td mat-footer-cell *matFooterCellDef>  </td>
                    </ng-container>
                    <ng-container *ngIf="column == 'TOTAL'">
                        <td mat-cell *matCellDef="let transaction">
                            <ng-container *ngIf='transaction.anulada == false' >
                                {{transaction.TOTAL | currency}}  
                            </ng-container>
                            <ng-container *ngIf='transaction.anulada == true'>                                    
                                <p style="color: #FF3333">{{transaction.TOTAL | currency}} </p>
                            </ng-container>                                  
                        </td>
                        <td mat-footer-cell *matFooterCellDef> {{ this.totalVentas | currency }} </td>
                    </ng-container>                       
                </ng-container>                                        
            </ng-container>                              
            <tr mat-footer-row *matFooterRowDef="columnsToDisplay; sticky: true"></tr>
           
            <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
            
            <ng-container matColumnDef="expandedDetail">
                
                
                <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
                    <div class="example-element-detail" [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                        <div class="container">
                            <div class="row">                              
                              <div class="col-12 align-self-center">
                                <table class="comicGreen">
                                    <thead>
                                        <tr > 

                                            <th>Producto</th>
                                            <th>Codigo</th>
                                            <th>Rubro</th>
                                            <th>Precio</th>
                                            <th>Cant</th>
                                            <th>SubTotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let producto of element.productosVendidos" >                        
                                            <td>{{producto.nombre}}</td>
                                            <td>{{producto.codigo}}</td>
                                            <td>{{producto.rubro.categoryName}}</td>                                    
                                            <td>{{producto.precio | currency: '$'}}</td>
                                            <td>{{producto.cantidad}}</td>
                                            <td>{{producto.total | currency: '$'}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                              </div>
                              <div class="container">
                                <div class="d-flex flex-column">
                                    <div class="p-2">
                                        <button (click)="anularVenta(element.ventaId)" [disabled]="element.anulada" class="btn btn-outline-warning" > ANULAR </button>
                                    </div>
                                    <div class="p-2">
                                        <ng-container *ngIf="element.anulada">
                                            <p style="color:rgb(252, 2, 2);">***Venta anulada por usuario {{element.anuladaPor}}:{{element.anuladaFecha}}</p>
                                        </ng-container>    
                                    </div>
                                </div>
                                <p> </p>
                              </div>
                            </div>
                        </div>
                    </div>                
                </td>
            </ng-container>
            

            <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
            <tr mat-row *matRowDef="let element; columns: columnsToDisplay;" class="example-element-row" 
                [class.example-expanded-row]="expandedElement === element"
                (click)="expandedElement = expandedElement === element ? null : element">
            </tr>
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
        </table>  
    </div>

    <hr>